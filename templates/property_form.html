{% extends "base.html" %}

{% block title %}{{ 'Edit' if property else 'Add' }} Property{% endblock %}

{% block content %}
<div class="login-wrapper">
    <div class="login-container">
        <h2>{% if property %}Edit Property{% else %}Add New Property{% endif %}</h2>
        
        {% if property and property.images %}
        <div class="image-carousel-container">
            <div class="image-carousel">
                {% for image in property.images %}
                <div class="carousel-item {% if loop.first %}active{% endif %}">
                    <!-- Use the direct photo_url instead of constructing a path -->
                    <img src="{{ image.photo_url }}" alt="Property image">
                    <div class="image-controls">
                        <button type="button" class="delete-image-btn" data-image-id="{{ image.id }}">Delete</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button class="carousel-prev">❮</button>
            <button class="carousel-next">❯</button>
            <div class="carousel-indicators">
                {% for image in property.images %}
                <span class="indicator {% if loop.first %}active{% endif %}" data-index="{{ loop.index0 }}"></span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <form method="POST" enctype="multipart/form-data" class="login-form">
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" id="title" name="title" value="{{ property.title if property else '' }}" required>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" required>{{ property.description if property else '' }}</textarea>
            </div>

            <div class="form-group">
                <label for="location">Location</label>
                <input type="text" id="location" name="location" value="{{ property.location if property else '' }}" required>
            </div>

            <div class="form-row">
                <div class="form-group half">
                    <label for="price">Price</label>
                    <input type="number" id="price" name="price" value="{{ property.price if property else '' }}" required>
                </div>

                <div class="form-group half">
                    <label for="area">Area (sqft)</label>
                    <input type="number" id="area" name="area" value="{{ property.area if property else '' }}" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group half">
                    <label for="bedrooms">Bedrooms</label>
                    <input type="number" id="bedrooms" name="bedrooms" value="{{ property.bedrooms if property else '' }}" required>
                </div>

                <div class="form-group half">
                    <label for="bathrooms">Bathrooms</label>
                    <input type="number" id="bathrooms" name="bathrooms" value="{{ property.bathrooms if property else '' }}" required>
                </div>
            </div>

            <div class="form-group">
                <label for="property_type">Property Type</label>
                <select id="property_type" name="property_type" required>
                    <option value="house" {% if property and property.property_type == 'house' %}selected{% endif %}>House</option>
                    <option value="apartment" {% if property and property.property_type == 'apartment' %}selected{% endif %}>Apartment</option>
                    <option value="commercial" {% if property and property.property_type == 'commercial' %}selected{% endif %}>Commercial</option>
                </select>
            </div>

            <div class="form-group">
                <label for="photos">Photos</label>
                <input type="file" id="photos" name="photos" multiple accept="image/*">
                <small class="form-text">Select multiple files to upload several images at once.</small>
            </div>

            <button type="submit" class="btn-login">{% if property %}Update Property{% else %}Add Property{% endif %}</button>
        </form>
    </div>
</div>

<!-- CSS for the carousel -->
<style>
.image-carousel-container {
    position: relative;
    width: 100%;
    margin-bottom: 20px;
    overflow: hidden;
    border-radius: 5px;
}

.image-carousel {
    display: flex;
    transition: transform 0.5s ease;
    height: 300px;
}

.carousel-item {
    min-width: 100%;
    position: relative;
    display: none;
}

.carousel-item.active {
    display: block;
}

.carousel-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-controls {
    position: absolute;
    bottom: 10px;
    right: 10px;
}

.delete-image-btn {
    background-color: rgba(255, 0, 0, 0.7);
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
}

.carousel-prev, .carousel-next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 50%;
    font-size: 18px;
}

.carousel-prev {
    left: 10px;
}

.carousel-next {
    right: 10px;
}

.carousel-indicators {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 5px;
}

.indicator {
    width: 10px;
    height: 10px;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    cursor: pointer;
}

.indicator.active {
    background-color: white;
}
</style>

<!-- JavaScript for the carousel -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.querySelector('.image-carousel');
    if (!carousel) return;
    
    const items = document.querySelectorAll('.carousel-item');
    const prevBtn = document.querySelector('.carousel-prev');
    const nextBtn = document.querySelector('.carousel-next');
    const indicators = document.querySelectorAll('.indicator');
    
    let currentIndex = 0;
    
    // Function to update carousel display
    function updateCarousel() {
        items.forEach((item, index) => {
            item.classList.toggle('active', index === currentIndex);
        });
        
        indicators.forEach((indicator, index) => {
            indicator.classList.toggle('active', index === currentIndex);
        });
    }
    
    // Previous button
    prevBtn.addEventListener('click', () => {
        currentIndex = (currentIndex - 1 + items.length) % items.length;
        updateCarousel();
    });
    
    // Next button
    nextBtn.addEventListener('click', () => {
        currentIndex = (currentIndex + 1) % items.length;
        updateCarousel();
    });
    
    // Indicators
    indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => {
            currentIndex = index;
            updateCarousel();
        });
    });
    
    // Delete image buttons
    const deleteButtons = document.querySelectorAll('.delete-image-btn');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const imageId = this.getAttribute('data-image-id');
            if (confirm('Are you sure you want to delete this image?')) {
                fetch('/delete_image/' + imageId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove this image from the carousel
                        const parentItem = this.closest('.carousel-item');
                        const index = Array.from(items).indexOf(parentItem);
                        
                        // If removing the current image, adjust currentIndex
                        if (index === currentIndex) {
                            currentIndex = items.length > 1 ? (currentIndex + 1) % items.length : 0;
                        }
                        
                        parentItem.remove();
                        indicators[index].remove();
                        
                        // Update the carousel
                        updateCarousel();
                        
                        // If no images left, hide the carousel
                        if (items.length === 0) {
                            document.querySelector('.image-carousel-container').style.display = 'none';
                        }
                    } else {
                        alert('Failed to delete image: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the image.');
                });
            }
        });
    });
});
</script>
{% endblock %}